<div class="container">
  <div class="row">
    <div class="col-md-3 border-right">
      <%= render "public/users/sidebar" %>
    </div>
    <div class="col-md-9">
      <div class="content">
        <!-- 学習内容の投稿フォーム -->
        <div class="row">
          <div class="col-md-5">
            <h3>学習内容を投稿しよう！</h3>
            <%= form_with(model: [@user, @post], url: public_user_posts_path(@user), method: :post) do |form| %>
              <div class="field">
                <%= form.label :learning_item, '学習項目' %>
                <%= form.select :learning_item, Post.learning_items.keys, prompt: '選択してください' %>
              </div>
              <div class="field">
                <%= form.label :learning_hour, '学習時間' %>
                <%= form.number_field :learning_hour, min: 1, max: 24 %>
              </div>
              <div class="field">
                <%= form.label :learning_content, '学習内容' %>
                <%= form.text_area :learning_content %>
              </div>
              <div class="actions">
                <%= form.submit '投稿' %>
              </div>
            <% end %>
          </div>
          <div class="col-md-7">
            <p>学習時間の合計: <%= @total_learning_hours %> 時間</p>
            <div id="weekly-learning-chart"></div>
          </div>
        </div>

        <!-- ユーザーの投稿一覧 -->
        <% if @posts.any? %>
          <h3><%= @user_name %>さんの投稿</h3>
          <div class="container">
            <div class="row">
              <div class="col-md-12">
                <% @posts.each do |post| %>
                  <div class="card mb-3">
                    <div class="card-header">
                      <span><%= post.created_at.in_time_zone('Tokyo').strftime("%Y-%m-%d %H:%M") %></span>
                      <span class="float-right">
                        <% if post.favorited_by?(current_user) %>
                          <%= link_to public_post_favorites_url(post, post.favorites.find_by(user_id: current_user.id)), method: :delete do %>
                            <i class="fa-regular fa-thumbs-up"></i> <%= post.favorites.count %>
                          <% end %>
                        <% else %>
                          <%= link_to public_post_favorites_path(post), method: :post do %>
                            <i class="fa-solid fa-thumbs-up"></i> <%= post.favorites.count %>
                          <% end %>
                        <% end %>
                      </span>
                    </div>
                    <div class="card-body">
                      <h5 class="card-title"><%= post.learning_item %></h5>
                      <p class="card-text">学習時間: <%= post.learning_hour %> 時間</p>
                      <p class="card-text">学習内容: <%= post.learning_content %></p>
                      <a href="<%= public_post_path(post.id) %>" class="btn btn-primary">コメントする</a>
                      <% if post.user == current_user %>
                        <%= link_to '編集', edit_public_post_path(post), class: "btn btn-secondary" %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% else %>
          <p>まだ投稿がありません。</p>
        <% end %>

        <!-- ページネーションとリンク -->
        <div class="pagination">
          <%= paginate @posts %>
        </div>
        <%= link_to "みんなの投稿", public_posts_path %>

        <!-- 合計学習時間の表示 -->
        <h3>学習時間の合計: <%= @total_learning_hours %> 時間</h3>

        <!-- 学習項目別の学習時間の合計の表示 -->
        <% if @learning_items_total.present? %>
          <h4>学習項目別の学習時間の合計</h4>
          <ul>
            <% @learning_items_total.each do |learning_item, total_hours| %>
              <div><i class="fa-solid fa-book-open"></i><%= learning_item %>: <%= total_hours %> 時間</div>
            <% end %>
          </ul>
        <% end %>

        <!-- 学習項目別の学習時間の合計のグラフ -->
        <% if @learning_items_total.present? %>
          <h4>学習項目別の学習時間の合計</h4>
          <div id="chart_div" style="width: 100%; height: 300px;"></div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Google チャートのスクリプト読み込みと描画 -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(drawCharts);

  function drawCharts() {
    // 過去一週間の学習時間のグラフ
    var weeklyData = new google.visualization.DataTable();
    weeklyData.addColumn('string', '日付');
    weeklyData.addColumn('number', '学習時間');
    weeklyData.addRows([
      <% @weekly_learning_hours.each do |data| %>
        ['<%= data[:date] %>', <%= data[:hours] %>],
      <% end %>
    ]);

    var weeklyOptions = {
      title: '過去一週間の学習時間',
      curveType: 'function',
      legend: { position: 'bottom' }
    };

    var weeklyChart = new google.visualization.LineChart(document.getElementById('weekly-learning-chart'));
    weeklyChart.draw(weeklyData, weeklyOptions);

    // 学習項目別の学習時間の合計のグラフ
    <% if @chart_data.present? %>
      var chartData = google.visualization.arrayToDataTable(<%= @chart_data.to_json.html_safe %>);

      var options = {
        title: '学習項目別の学習時間の合計',
        legend: { position: 'none' },
      };

      var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
      chart.draw(chartData, options);
    <% end %>
  }
</script>
